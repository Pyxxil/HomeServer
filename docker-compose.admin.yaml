x-common-admin: &admin
  traefik:
    container_name: dash
    image: traefik
    <<: *common
    networks:
      - frontend
    command:
      - --accesslog=true
      - --accesslog.addinternals
      - --accesslog.bufferingsize=100
      - --accesslog.format=json
      - --accesslog.filters.statuscodes=200,300-302
      - --accesslog.filters.retryattempts
      - --accesslog.filters.minduration=10ms
      - --api=true
      - --api.dashboard=true
      - --certificatesresolvers.letsencrypt.acme.caserver=https://acme-v02.api.letsencrypt.org/directory
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=0
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53,9.9.9.9:53
      - --certificatesresolvers.letsencrypt.acme.email=${ADMIN_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/config/acme.json
      - --entryPoints.ldaps.address=:636/tcp
      - --entryPoints.mqtts.address=:8883
      - --entryPoints.web.address=:80
      - --entryPoints.web.forwardedHeaders.insecure=false
      - --entryPoints.web.proxyProtocol.insecure=false
      - --entryPoints.web.forwardedHeaders.trustedIPs=${TRUSTED_IPS}
      - --entryPoints.web.proxyProtocol.trustedIPs=${TRUSTED_IPS}
      - --entryPoints.web.http.redirections.entryPoint.to=websecure
      - --entryPoints.web.http.redirections.entryPoint.scheme=https
      - --entryPoints.web.http.redirections.entryPoint.permanent=true
      - --entryPoints.websecure.address=:443
      - --entryPoints.websecure.http.middlewares=compress@file,security@file
      - --entryPoints.websecure.http.tls.certResolver=letsencrypt
      - --entryPoints.websecure.http.tls.domains[0].main=${DOMAIN}
      - --entryPoints.websecure.http.tls.domains[0].sans=*.${DOMAIN}
      - --entryPoints.websecure.http3
      - --entryPoints.websecure.http3.advertisedport=443
      - --entryPoints.websecure.forwardedHeaders.trustedIPs=${TRUSTED_IPS}
      - --entryPoints.websecure.proxyProtocol.trustedIPs=${TRUSTED_IPS}
      - --entryPoints.websecure.forwardedHeaders.insecure=false
      - --entryPoints.websecure.proxyProtocol.insecure=false
      - --entryPoints.websecure.transport.respondingTimeouts.readTimeout=0s
      - --log.compress=true
      - --log.format=json
      - --log.level=info
      - --ping=true
      - --metrics.prometheus=true
      - --metrics.prometheus.addServicesLabels=true
      - --metrics.prometheus.addrouterslabels=true
      - --metrics.prometheus.addEntryPointsLabels=true
      - --metrics.addinternals
      - --providers.docker.defaultRule=Host(`{{ .ContainerName }}.${DOMAIN}`)
      - --providers.docker=true
      - --providers.docker.watch=true
      - --providers.docker.exposedbydefault=true
      - --providers.docker.network=frontend
      - --providers.file.directory=/config
    environment:
      <<: *env-vars
      CLOUDFLARE_DNS_API_TOKEN: ${CLOUDFLARE_DNS_API_TOKEN}
    ports:
      - 0.0.0.0:80:80
      - 0.0.0.0:443:443/udp
      - 0.0.0.0:443:443/tcp
      - 0.0.0.0:636:636/tcp
      - 0.0.0.0:8883:8883
      - ":::80:80"
      - ":::443:443/udp"
      - ":::443:443/tcp"
      - ":::636:636/tcp"
      - ":::8883:8883"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - config-traefik:/config
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      <<: *healthcheck
    depends_on:
      - auth
    labels:
      traefik.http.routers.dashboard.rule: Host(`dash.${DOMAIN}`) && $RESTRICTED
      traefik.http.routers.dashboard.service: api@internal
      traefik.http.routers.dashboard.tls: true
      traefik.http.routers.dashboard.tls.certResolver: letsencrypt
      traefik.http.routers.dashboard.entryPoints: websecure
      traefik.http.routers.dashboard.middlewares: auth@file

  whoami:
    image: traefik/whoami
    container_name: whoami
    <<: *common
    labels:
      traefik.http.routers.whoami.entryPoints: websecure

  auth:
    image: authelia/authelia
    container_name: auth
    <<: *common
    depends_on:
      - ldap
    volumes:
      - config-authelia:/config
    labels:
      traefik.http.services.auth.loadbalancer.server.port: 9091
      traefik.http.routers.auth.entryPoints: websecure
      traefik.http.routers.auth.tls: true
      traefik.http.routers.auth.tls.certResolver: letsencrypt
      traefik.http.middlewares.cors.headers.accesscontrolalloworiginlistregex: https://[a-z]+.${DOMAIN}
      traefik.http.routers.auth.middlewares: cors

  ldap:
    image: osixia/openldap
    container_name: ldap
    <<: *common
    hostname: ldap.${DOMAIN}
    restart: always
    volumes:
      - config-ldap-db:/var/lib/ldap
      - config-ldap:/etc/ldap/slapd.d
    healthcheck:
      test: ["CMD-SHELL", "ldapsearch -Y EXTERNAL -H ldapi:/// | grep -i 'numresponses' || exit 1"]
      <<: *healthcheck
    environment:
      <<: *env-vars
      LDAP_ORGANISATION: ${ORGANISATION}
      LDAP_DOMAIN: ${DOMAIN}
      LDAP_BASE_DN: dc=${DC_DOMAIN},dc=${TLD}
      LDAP_RFC2307BIS_SCHEMA: true
      LDAP_ADMIN_PASSWORD: ${LDAP_PASSWORD}
      LDAP_READONLY_USER: false
      LDAP_TLS: true
      LDAP_TLS_VERIFY_CLIENT: 'never'
    labels:
      traefik.tcp.routers.ldap.rule: HostSNI(`${DOMAIN}`)
      traefik.tcp.services.ldap.loadbalancer.server.port: 389
      traefik.tcp.routers.ldap.entryPoints: ldaps
      traefik.tcp.routers.ldap.tls: true
      traefik.tcp.routers.ldap.tls.certResolver: letsencrypt

  ldap-user-manager:
    image: wheelybird/ldap-user-manager
    container_name: account
    hostname: account.${DOMAIN}
    <<: *common
    depends_on:
      - ldap
    healthcheck:
      test: ["CMD-SHELL", "curl --fail localhost:80"]
      <<: *healthcheck
    environment:
      <<: *env-vars
      SERVER_HOSTNAME: account.${DOMAIN}
      ORGANISATION_NAME: ${ORGANISATION}
      LDAP_URI: "ldaps://${DOMAIN}"
      LDAP_BASE_DN: dc=${DC_DOMAIN},dc=${TLD}
      LDAP_ADMINS_GROUP: "admins"
      LDAP_ADMIN_BIND_DN: "cn=admin,dc=${DC_DOMAIN},dc=${TLD}"
      LDAP_ADMIN_BIND_PWD: ${LDAP_PASSWORD}
      LDAP_USES_NIS_SCHEMA: false
      LDAP_REQUIRE_STARTTLS: false
      LDAP_IGNORE_CERT_ERRORS: false
      LDAP_DEBUG: true
      NO_HTTPS: true
      SMTP_LOG_LEVEL: 3
      SMTP_HOSTNAME: ${SMTP_HOST}
      SMTP_HOST_PORT: 25
      SMTP_USE_TLS: true
      SMTP_USERNAME: ${SMTP_USER}
      SMTP_PASSWORD: ${SMTP_PASS}
      EMAIL_FROM_ADDRESS: account@${DOMAIN}
      EMAIL_DOMAIN: ${DOMAIN}
    labels:
      traefik.http.services.ldap-user-manager.loadbalancer.server.port: 80
      traefik.http.routers.ldap-user-manager.entryPoints: websecure
      traefik.http.routers.ldap-user-manager.tls: true
      traefik.http.routers.ldap-user-manager.tls.certResolver: letsencrypt

  ntfy:
    image: binwiederhier/ntfy
    container_name: ntfy
    <<: *common
    command:
      - serve
    volumes:
      - config-ntfy-cache:/var/cache/ntfy
      - config-ntfy:/etc/ntfy
    healthcheck:
      test: ["CMD-SHELL", "wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1"]
      <<: *healthcheck
    labels:
      traefik.http.routers.ntfy.rule: Host(`ntfy.${DOMAIN}`) && $RESTRICTED
      traefik.http.routers.ntfy.entryPoints: websecure
      traefik.http.services.ntfy.loadbalancer.server.port: 80
      traefik.http.routers.ntfy.tls: true
      traefik.http.routers.ntfy.tls.certresolver: letsencrypt

  vpn:
    image: qmcgaw/gluetun
    container_name: vpn
    <<: *common
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
    environment:
      <<: *env-vars
      VPN_SERVICE_PROVIDER: mullvad
      VPN_TYPE: wireguard
      WIREGUARD_PRIVATE_KEY: $MULLVAD_PRIVATE_KEY
      WIREGUARD_ADDRESSES: $MULLVAD_ADDRESSES
      SERVER_COUNTRIES: Switzerland,Sweden,Netherlands
      OWNED_ONLY: yes
      WIREGUARD_ENDPOINT_PORT: $MULLVAD_ENDPOINT_PORT
      FIREWALL_OUTBOUND_SUBNETS: 172.20.0.0/14,fd00::/112
    labels:
      traefik.http.routers.qbittorrent.rule: Host(`downloads.${DOMAIN}`) && $RESTRICTED
      traefik.http.routers.qbittorrent.entryPoints: websecure
      traefik.http.services.qbittorrent.loadbalancer.server.port: 8980
      traefik.http.services.qbittorrent.loadbalancer.passhostheader: false
      traefik.http.routers.qbittorrent.tls: true
      traefik.http.routers.qbittorrent.tls.certResolver: letsencrypt
      traefik.http.middlewares.qbittorrent-headers.headers.customrequestheaders.X-Frame-Options: SAMEORIGIN
      traefik.http.middlewares.qbittorrent-headers.headers.customrequestheaders.Referer: ""
      traefik.http.middlewares.qbittorrent-headers.headers.customrequestheaders.Origin: ""
      traefik.http.routers.qbittorrent.middlewares: qbittorrent-headers,auth@file
      traefik.http.routers.qbittorrent.service: qbittorrent
      traefik.http.routers.qbittorrent.priority: 99

